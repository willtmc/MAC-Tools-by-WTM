{% extends "base.html" %}

{% block title %}Preview Letter{% endblock %}

{% block content %}
<div class="mclemore-container">
    <h1 class="mclemore-title">Preview Letter</h1>
    <h3 class="mclemore-subtitle">Auction: {{ auction_code }}</h3>

    <div class="row">
        <div class="col-md-6">
            <div class="mclemore-card">
                <div class="mclemore-card-header">
                    <h4 class="mclemore-subtitle mb-0">Auction Details</h4>
                </div>
                <div class="mclemore-card-body">
                    <p><strong>Title:</strong> {{ auction.title }}</p>
                    <p><strong>Location:</strong> {{ auction.location }}</p>
                    <p><strong>Date:</strong> {{ auction.date }}</p>
                    <p><strong>Time:</strong> {{ auction.time }}</p>
                    {% if auction.description %}
                    <p><strong>Description:</strong> {{ auction.description }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="mclemore-card">
                <div class="mclemore-card-header">
                    <h4 class="mclemore-subtitle mb-0">Letter Preview</h4>
                </div>
                <div class="mclemore-card-body">
                    {% if sample_addresses %}
                        {% for address in sample_addresses %}
                        <div class="preview-container mb-4">
                            <h5>Preview for {{ address.name }}</h5>
                            <div class="letter-preview">
                                {{ template | replace('{{name}}', address.name)
                                          | replace('{{auction_title}}', auction.title)
                                          | replace('{{auction_date}}', auction.date)
                                          | replace('{{auction_time}}', auction.time)
                                          | replace('{{auction_location}}', auction.location)
                                          | replace('{{address_line1}}', address.address_line1)
                                          | replace('{{address_city}}', address.address_city)
                                          | replace('{{address_state}}', address.address_state)
                                          | replace('{{address_zip}}', address.address_zip)
                                          | safe }}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p>No sample addresses available for preview. Please upload addresses first.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="d-flex justify-content-between">
                <a href="{{ url_for('neighbor_letters.edit_letter', auction_code=auction_code) }}" class="mclemore-btn mclemore-btn-secondary">Back to Edit</a>
                {% if sample_addresses %}
                <button id="sendLetters" class="mclemore-btn mclemore-btn-primary">Send Letters</button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('sendLetters')?.addEventListener('click', async function() {
    try {
        const response = await fetch(`{{ url_for('neighbor_letters.send_letters', auction_code=auction_code) }}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({
                letter_content: {{ template | tojson }}
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`Letters sent successfully! ${data.details.addresses_sent} letters will be delivered.`);
            window.location.href = "{{ url_for('neighbor_letters.home') }}";
        } else {
            alert(`Error: ${data.error}`);
        }
    } catch (error) {
        alert('An error occurred while sending the letters. Please try again.');
        console.error('Error:', error);
    }
});
</script>

<style>
.letter-preview {
    border: 1px solid #ddd;
    padding: 20px;
    margin-top: 10px;
    background: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.preview-container {
    border-bottom: 1px solid #eee;
    padding-bottom: 20px;
}

.preview-container:last-child {
    border-bottom: none;
}
</style>
{% endblock %}
