<!DOCTYPE html>
<html>
<head>
    <title>Edit Letter Template</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/mclemore.css') }}" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <span class="navbar-brand">Edit Letter Template</span>
            <div class="navbar-nav">
                <a class="nav-link mclemore-link" href="{{ url_for('neighbor_letters_bp.home') }}">Back to Letters</a>
            </div>
        </div>
    </nav>

    <div class="mclemore-container mt-5">
        {% if auction_details %}
        <h1 class="mclemore-title">{{ auction_details.title }}</h1>
        <div class="mclemore-section">
            <div class="mclemore-info-box">
                <h3 class="mclemore-section">Auction Details</h3>
                <p class="mclemore-text"><strong>Date:</strong> {{ auction_details.date }}</p>
                <p class="mclemore-text"><strong>Time:</strong> {{ auction_details.time }}</p>
                <p class="mclemore-text"><strong>Location:</strong> {{ auction_details.location }}</p>
                <p class="mclemore-text">{{ auction_details.description }}</p>
            </div>
        </div>
        {% else %}
        <h1 class="mclemore-title">Edit Letter Template for Auction {{ auction_code }}</h1>
        {% endif %}
        
        <div class="mclemore-section">
            <div class="mclemore-info-box mt-3">
                <h3 class="mclemore-section">Sample Address</h3>
                {% if sample_address %}
                <div class="mclemore-text">
                    <p><strong>Name:</strong> {{ sample_address.Name }}</p>
                    <p><strong>Address:</strong> {{ sample_address.Address }}</p>
                    <p><strong>City:</strong> {{ sample_address.City }}</p>
                    <p><strong>State:</strong> {{ sample_address.State }}</p>
                    <p><strong>Zip:</strong> {{ sample_address.Zip }}</p>
                </div>
                {% else %}
                <p class="mclemore-text">No sample address available.</p>
                {% endif %}
            </div>

            <form id="letterForm" class="mclemore-form mt-4">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="mclemore-form-group">
                    <label class="mclemore-label" for="letterContent">Letter Content</label>
                    <textarea class="mclemore-input" id="letterContent" name="letterContent" rows="10" required>Dear {Name},

We wanted to let you know about an upcoming auction near your property. McLemore Auction Company is conducting an auction of {{ auction_details.title if auction_details else 'the property' }} located at {Address}.

{% if auction_details %}{{ auction_details.description }}

{% endif %}The auction will be held on {{ auction_details.date if auction_details else '{AuctionDate}' }} at {{ auction_details.time if auction_details else '{AuctionTime}' }}. You can find more details about this auction at:
https://www.mclemoreauction.com/auction/{{ auction_code }}

If you have any questions or would like to learn more about the property, please don't hesitate to contact us at (615) 517-7675 or will@mclemoreauction.com.

Best regards,
Will McLemore
McLemore Auction Company
will@mclemoreauction.com
(615) 517-7675</textarea>
                </div>
                <div class="mclemore-form-group">
                    <label class="mclemore-label" for="auctionDate">Auction Date</label>
                    <input type="date" class="mclemore-input" id="auctionDate" name="auctionDate" value="{{ auction_date }}" required>
                </div>
                <div class="mclemore-form-group">
                    <label class="mclemore-label" for="auctionTime">Auction Time</label>
                    <input type="time" class="mclemore-input" id="auctionTime" name="auctionTime" value="{{ auction_time }}" required>
                </div>
                <button type="submit" class="mclemore-button mclemore-button-primary">Preview Letters</button>
            </form>

            <div id="results" class="mclemore-section mt-4" style="display: none;">
                <h3 class="mclemore-subtitle">Preview</h3>
                <div id="resultContent" class="mclemore-text"></div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('letterForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('letter_content', document.getElementById('letterContent').value);
            formData.append('auction_date', document.getElementById('auctionDate').value);
            formData.append('auction_time', document.getElementById('auctionTime').value);
            formData.append('csrf_token', document.querySelector('input[name="csrf_token"]').value);
            
            try {
                const response = await fetch(`/letters/preview/{{ auction_code }}`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                const resultsDiv = document.getElementById('results');
                const resultContent = document.getElementById('resultContent');
                
                resultsDiv.style.display = 'block';
                
                if (result.success) {
                    resultContent.innerHTML = `
                        <div class="alert alert-success">
                            <h4>Preview Generated</h4>
                            <p>Sample letter:</p>
                            <pre>${result.sample_letter}</pre>
                            <div class="mt-3">
                                <button type="button" class="mclemore-button mclemore-button-success" onclick="generateLetters()">
                                    Generate All Letters
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    resultContent.innerHTML = `
                        <div class="alert alert-danger">
                            <h4>Error</h4>
                            <p>${result.message}</p>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('results').style.display = 'block';
                document.getElementById('resultContent').innerHTML = `
                    <div class="alert alert-danger">
                        <h4>Error</h4>
                        <p>Error generating preview: ${error.message}</p>
                    </div>
                `;
            }
        });

        async function generateLetters() {
            try {
                const response = await fetch(`/letters/generate/{{ auction_code }}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
                    },
                    body: JSON.stringify({
                        letter_content: document.getElementById('letterContent').value,
                        auction_date: document.getElementById('auctionDate').value,
                        auction_time: document.getElementById('auctionTime').value
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    window.location.href = `/letters/download/${result.filename}`;
                } else {
                    document.getElementById('resultContent').innerHTML = `
                        <div class="alert alert-danger">
                            <h4>Error</h4>
                            <p>${result.message}</p>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('resultContent').innerHTML = `
                    <div class="alert alert-danger">
                        <h4>Error</h4>
                        <p>Error generating letters: ${error.message}</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
